#!/bin/bash
# GSDF 坐标转换功能使用示例

echo "================================================"
echo "GSDF 坐标转换功能使用示例"
echo "================================================"

# 假设场景名为 0a184cf634
SCENE_NAME="0a184cf634"
DATA_DIR="/root/autodl-tmp/Proj/GS-Reconstruction/Data/ScanNetpp/${SCENE_NAME}"
EXP_DIR="./exp/${SCENE_NAME}/with_prior@20260125-185155"

echo ""
echo "场景: ${SCENE_NAME}"
echo "数据目录: ${DATA_DIR}"
echo "实验目录: ${EXP_DIR}"
echo ""

# ============================================================
# 示例 1: 训练时自动生成转换参数并导出原始坐标系mesh
# ============================================================
echo "============================================================"
echo "示例 1: 训练并自动导出原始坐标系mesh"
echo "============================================================"
echo ""
echo "训练时会自动："
echo "1. 在数据目录生成 transform_params_sdf.json"
echo "2. 在 ${DATA_DIR}/ 保存变换参数"
echo "3. 导出mesh时自动应用逆变换"
echo "4. 生成 *_original.ply 文件（原始坐标系）"
echo ""
echo "运行训练:"
echo "  bash train_scannetpp_smart.sh"
echo ""

# ============================================================
# 示例 2: 查看保存的变换参数
# ============================================================
echo "============================================================"
echo "示例 2: 查看保存的变换参数"
echo "============================================================"
echo ""
if [ -f "${DATA_DIR}/transform_params_sdf.json" ]; then
    echo "SDF分支变换参数:"
    cat "${DATA_DIR}/transform_params_sdf.json"
else
    echo "变换参数文件示例内容:"
    cat << 'EOF'
{
  "center": [0.5234, 0.3421, 0.2134],
  "scale": 2.5,
  "inv_trans": [
    [1.0, 0.0, 0.0, -0.5234],
    [0.0, 1.0, 0.0, -0.3421],
    [0.0, 0.0, 1.0, -0.2134],
    [0.0, 0.0, 0.0, 1.0]
  ]
}
EOF
fi
echo ""

# ============================================================
# 示例 3: 手动转换单个mesh文件
# ============================================================
echo "============================================================"
echo "示例 3: 手动转换单个mesh文件"
echo "============================================================"
echo ""
echo "如果你有一个归一化坐标系下的mesh，可以手动转换："
echo ""
echo "python transform_mesh.py \\"
echo "    --input ${EXP_DIR}/save/it30000-mc1024.ply \\"
echo "    --transform ${DATA_DIR}/transform_params_sdf.json \\"
echo "    --output ${EXP_DIR}/save/it30000-mc1024_original.ply"
echo ""

# ============================================================
# 示例 4: 批量转换目录下所有mesh
# ============================================================
echo "============================================================"
echo "示例 4: 批量转换目录下所有mesh"
echo "============================================================"
echo ""
echo "批量转换一个目录下的所有mesh文件："
echo ""
echo "python transform_mesh.py \\"
echo "    --input_dir ${EXP_DIR}/save/ \\"
echo "    --transform ${DATA_DIR}/transform_params_sdf.json \\"
echo "    --output_dir ${EXP_DIR}/save/meshes_original/ \\"
echo "    --suffix _original"
echo ""

# ============================================================
# 示例 5: 手动指定变换参数
# ============================================================
echo "============================================================"
echo "示例 5: 手动指定变换参数（无JSON文件）"
echo "============================================================"
echo ""
echo "如果没有保存的变换参数，可以手动指定："
echo ""
echo "python transform_mesh.py \\"
echo "    --input mesh_normalized.ply \\"
echo "    --manual \\"
echo "    --center 0.5 0.3 0.2 \\"
echo "    --scale 2.5 \\"
echo "    --output mesh_original.ply"
echo ""

# ============================================================
# 示例 6: 与GT mesh对比评估
# ============================================================
echo "============================================================"
echo "示例 6: 与GT mesh对比评估"
echo "============================================================"
echo ""
echo "转换到原始坐标系后，可以直接与GT mesh对比："
echo ""
echo "# 假设你有GT mesh"
echo "GT_MESH=\"${DATA_DIR}/gt_mesh.ply\""
echo "PRED_MESH=\"${EXP_DIR}/save/it30000-mc1024_original.ply\""
echo ""
echo "# 使用评估工具（例如2DGS的评估脚本）"
echo "python eval_mesh.py \\"
echo "    --pred \${PRED_MESH} \\"
echo "    --gt \${GT_MESH} \\"
echo "    --output metrics.json"
echo ""
echo "# 或者使用CloudCompare等工具进行可视化对比"
echo ""

# ============================================================
# 常见问题
# ============================================================
echo "============================================================"
echo "常见问题"
echo "============================================================"
echo ""
echo "Q1: 找不到 transform_params_sdf.json 文件？"
echo "A1: 这个文件在数据加载时自动生成。如果没有，说明："
echo "    - 可能是用旧代码训练的，需要重新运行数据加载"
echo "    - 或者需要手动指定变换参数"
echo ""
echo "Q2: 转换后mesh还是与GT不对齐？"
echo "A2: 检查："
echo "    - 是否使用了正确的变换参数文件（SDF/GS）"
echo "    - GT mesh是否确实在原始坐标系下"
echo "    - 配置文件中是否指定了 neuralangelo_scale/center"
echo ""
echo "Q3: 如何验证转换是否正确？"
echo "A3: 查看导出时打印的bbox信息，对比："
echo "    - 原始点云的范围"
echo "    - 归一化后mesh的范围（应该在[-3.1, 3.1]左右）"
echo "    - 转换后mesh的范围（应该与原始点云相近）"
echo ""

echo "============================================================"
echo "更多信息请查看 COORDINATE_TRANSFORM_README.md"
echo "============================================================"
